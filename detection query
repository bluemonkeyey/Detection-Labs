let TimeWindow = 10m;
let SuspiciousDirs = dynamic([ @"\AppData\", @"\Temp\", @"\ProgramData\", @"\Public\" ]);
let SuspiciousDroppers = dynamic([ "mshta.exe", "wscript.exe", "cscript.exe", "powershell.exe", "pwsh.exe", "rundll32.exe" ]);
// --- Step 1: DLL dropped to user-writable path (by suspicious droppers)
let DroppedDLLs =
DeviceFileEvents_LAB
| where Timestamp > ago(TimeWindow)
| where ActionType == "FileCreated"
| where FileName endswith ".dll"
| where FolderPath has_any (SuspiciousDirs)
| where tolower(InitiatingProcessFileName) has_any (SuspiciousDroppers)
| project DeviceName, FileName, FolderPath, DllCreateTime = Timestamp, DropperProcess = InitiatingProcessFileName, DropperPid = InitiatingProcessId, DropperCmd = InitiatingProcessCommandLine;
// --- Step 2: DLL loaded into memory
let LoadedDLLs =
DeviceImageLoadEvents_LAB
| where Timestamp > ago(TimeWindow)
| where FileName endswith ".dll"
| where FolderPath has_any (SuspiciousDirs)
| project DeviceName, FileName, FolderPath, DllLoadTime = Timestamp, LoaderProcess = InitiatingProcessFileName, LoaderPid = InitiatingProcessId;
// --- Step 3: correlate drop â†’ load (NO PID equality)
let DllChain =
DroppedDLLs
| join kind=inner (LoadedDLLs) on DeviceName, FileName
| where DllLoadTime between (DllCreateTime .. DllCreateTime + 5m);
// --- Step 4: enrich with process context of the LOADER
DllChain
| join kind=leftouter (
    DeviceProcessEvents_LAB
    | where ActionType == "ProcessCreated"
    | project
 DeviceName, ProcessId, LoaderCmd = ProcessCommandLine, ParentProcessName, ParentProcessId, IntegrityLevel
) on DeviceName, $left.LoaderPid == $right.ProcessId
| project  DeviceName,  FolderPath,  FileName,  DllCreateTime,  DllLoadTime,  TimeDelta = DllLoadTime - DllCreateTime,  DropperProcess,  DropperPid,  DropperCmd,  LoaderProcess,  LoaderPid,  LoaderCmd,  ParentProcessName,  ParentProcessId,  IntegrityLevel
| sort by TimeDelta asc
